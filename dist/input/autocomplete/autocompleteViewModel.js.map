{"version":3,"sources":["../../../src/input/autocomplete/autocompleteViewModel.js"],"names":[],"mappings":"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","file":"autocompleteViewModel.js","sourcesContent":["import { observable, observableArray, computed, unwrap } from 'knockout';\r\nimport { createViewModels as createViewModelsUnbound } from 'scalejs.metadataFactory';\r\nimport { evaluate } from 'scalejs.expression-jsep';\r\nimport { merge, has, is } from 'scalejs';\r\nimport dataservice from 'dataservice';\r\nimport _ from 'lodash';\r\n\r\n    export default function autocompleteViewModel(node, inputViewModel) {\r\n        var context = this,\r\n            dataSourceEndpoint = node.dataSourceEndpoint,\r\n            keyMap = node.keyMap || {},\r\n            createViewModels = createViewModelsUnbound.bind(this),\r\n            // inputViewModel\r\n            inputValue = inputViewModel.inputValue,\r\n            subs = inputViewModel.subs,\r\n            mapItem = inputViewModel.mapItem,\r\n            hasFocus = inputViewModel.hasFocus,\r\n            readonly = inputViewModel.readonly,\r\n            isShown = inputViewModel.isShown,\r\n            // props\r\n            autocompleteSource = observableArray(),\r\n            mappedChildNodes = observableArray(),\r\n            sourceArray,\r\n            validations,\r\n            options = node.options || {},\r\n            unique = options.unique,\r\n            computedSource,\r\n            itemMapper = mapItem(keyMap),\r\n            objectValue;\r\n\r\n        function getValue() {\r\n            var item;\r\n            if (mappedChildNodes() && mappedChildNodes().length) {\r\n                //collect data from each node\r\n                //note: works well for multi input children..\r\n                return mappedChildNodes().reduce(function(obj, childNode) {\r\n                    return merge(obj, childNode.getValue && childNode.getValue());\r\n                }, {})\r\n            }\r\n            if (node.children) {\r\n                if (has(inputValue()) && inputValue() !== '') {\r\n                    item = _.find(autocompleteSource(), {value: inputValue() });\r\n                    if (item) { return item.original}\r\n                    return objectValue;\r\n                    //console.warn('Cant find value: ' + inputValue() + ' in autocompleteSource in node', node);\r\n                } else {\r\n                    return null;\r\n                }\r\n\r\n            }\r\n            //ret[keyMap.valueKey] = inputValue();\r\n            return inputValue();\r\n        }\r\n\r\n        function setValue(data) {\r\n            var value = is(data, 'object') && has(data.value) ? data.value : data,\r\n                d;\r\n            if(is(value, 'object')) {\r\n                var label = (Array.isArray(keyMap.textKey) ? keyMap.textKey : [keyMap.textKey]).map(function(k) {\r\n                        return value[k];\r\n                    }).join(keyMap.delimiter || ' / ');\r\n                inputValue(label);\r\n\r\n                objectValue = value;\r\n\r\n                if(!value[options.autocompleteId] && !_.find(autocompleteSource(), {value: inputValue() }) ) {\r\n                    mappedChildNodes(createViewModels(node.children));\r\n                    // todo: Refacctor because assuming too much about children, not generic enough\r\n                    mappedChildNodes().forEach(function(child) {\r\n                        child.mappedChildNodes.forEach(function(childNode) {\r\n                            if(childNode.setValue && childNode.id) {\r\n                                childNode.setValue(value[childNode.id]);\r\n                            }\r\n                        });\r\n                    });\r\n                }\r\n                return;\r\n            }\r\n            inputValue(value);\r\n        }\r\n\r\n        function mapAutocompleteSource(source) {\r\n            return source.map(function(src) {\r\n                if (typeof src === 'string') {\r\n                    return {\r\n                        value: src,\r\n                        label: src\r\n                    }\r\n                } else {\r\n                    return src;\r\n                }\r\n            });\r\n        }\r\n\r\n        function getAutocompleteSource() {\r\n            var contextData,\r\n                contextDataObject = {};\r\n\r\n            if (dataSourceEndpoint.data && dataSourceEndpoint.data.fromContext) {\r\n                contextData = context.getValue(dataSourceEndpoint.data.fromContext);\r\n                if (contextData === '') {\r\n                    autocompleteSource([]);\r\n                    inputValue('');\r\n                    return;\r\n                }\r\n                contextDataObject[dataSourceEndpoint.data.fromContext] = contextData;\r\n                dataSourceEndpoint.data = merge(dataSourceEndpoint.data, contextDataObject);\r\n            }\r\n            dataservice.ajax(dataSourceEndpoint, function(error, data) {\r\n                if (error) {\r\n                    console.error('Data retrieval failure', error);\r\n                    return;\r\n                }\r\n                if (keyMap.dataKey) {\r\n                    sourceArray  =  data[keyMap.dataKey];\r\n                    // todo: update to use mapItem\r\n                    var mappedData = data[keyMap.dataKey].map(function(d) {\r\n                        return keyMap.textKey && keyMap.valueKey ?\r\n                            {\r\n                                label: (Array.isArray(keyMap.textKey) ? keyMap.textKey : [keyMap.textKey]).map(function(k) {\r\n                                    return d[k];\r\n                                }).join(keyMap.delimiter || ' / '),\r\n                                value: d[keyMap.valueKey]\r\n                            }\r\n                            : d[node.id]; //todo: remove this and add mapping!\r\n                    })\r\n                    autocompleteSource(mapAutocompleteSource(_.uniqBy(mappedData, function(item) {\r\n                            return item ?  has(item, 'value') ? item.value : item : '';\r\n                    }).filter(Boolean))) // remove empty values\r\n                } else {\r\n                    sourceArray = data.SearchResults;\r\n                    autocompleteSource(mapAutocompleteSource(data.SearchResults));\r\n                }\r\n            });\r\n        }\r\n\r\n        function getAutocompleteSourceFromContext() {\r\n            var source = evaluate(node.autocompleteSource.fromArray, context.getValue);\r\n\r\n            // storing source array before any mapping\r\n            sourceArray = source;\r\n            if (Array.isArray(source)) {\r\n                autocompleteSource(\r\n                    _.uniqBy(\r\n                        source\r\n                            .map(itemMapper)\r\n                            //todo: remove additional mapping - using binding options\r\n                            .map(function(item) {\r\n                                return {\r\n                                    label: item.text,\r\n                                    value: item.value,\r\n                                    original: item.original\r\n                                };\r\n                            }),\r\n                        function(item) {\r\n                            return item.value;\r\n                        }\r\n                    )\r\n                );\r\n            }\r\n        }\r\n\r\n        function childSetReadonly(mappedNodes) {\r\n            var nodes = unwrap(mappedNodes);\r\n            nodes.forEach(function (child) {\r\n                if (child.setReadonly) {\r\n                    child.setReadonly(readonly());\r\n                } else if (child.mappedChildNodes) {\r\n                    childSetReadonly(child.mappedChildNodes);\r\n                }\r\n            })\r\n        }\r\n\r\n        function setReadonly(bool) {\r\n            readonly(bool);\r\n            childSetReadonly(mappedChildNodes);\r\n        }\r\n\r\n        function validateChildNodes(childNodes) {\r\n            return unwrap(childNodes).reduce(function (isInvalid, curr) {\r\n                if (curr.validate && typeof curr.validate === 'function') {\r\n                    return curr.validate() || isInvalid;\r\n                } else {\r\n                    return validateChildNodes(curr.mappedChildNodes || []) || isInvalid;\r\n                }\r\n            }, false);\r\n        }\r\n        // validates the input by setting isModified to true\r\n        // returns true if the input has an error\r\n        function validate() {\r\n            inputValue.isModified(true);\r\n            if(mappedChildNodes().length) {\r\n                return validateChildNodes(mappedChildNodes);\r\n            }\r\n            return !inputValue.isValid() && isShown() && this.rendered() && inputValue.severity() === 1;\r\n        }\r\n\r\n        if (dataSourceEndpoint) {\r\n            subs.push(computed(getAutocompleteSource));\r\n        }\r\n\r\n        if (Array.isArray(node.autocompleteSource)) {\r\n            sourceArray = node.autocompleteSource;\r\n            autocompleteSource(mapAutocompleteSource(node.autocompleteSource));\r\n        }\r\n\r\n        if (node.autocompleteSource && !Array.isArray(node.autocompleteSource)) {\r\n            subs.push(computed(getAutocompleteSourceFromContext).extend({ deferred: true }));\r\n        }\r\n\r\n        if (!options.addNew) {\r\n            validations = _.cloneDeep(options.validations) || {};\r\n            if (!validations || !validations.autocomplete ) {\r\n                validations.autocomplete = {\r\n                    message: 'Please choose a valid selection from the options.',\r\n                    params: autocompleteSource\r\n                }\r\n            } else {\r\n                validations.autocomplete = {\r\n                    message: validations.autocomplete.message || 'Please choose a valid selection from the options.',\r\n                    params: autocompleteSource\r\n                }\r\n            }\r\n        }\r\n\r\n        if (unique) {\r\n\r\n            inputValue.subscribe(function (oldValue) {\r\n                context.unique[node.id].remove(oldValue);\r\n            }, null, 'beforeChange');\r\n            inputValue.subscribe(function (newValue) {\r\n                if(context.deleteFlag && context.deleteFlag()) { return; }\r\n                context.unique[node.id].push(newValue);\r\n            });\r\n\r\n            if(context.deleteFlag) {\r\n                context.deleteFlag.subscribe(function(deleted) {\r\n                    if (deleted) {\r\n                        context.unique[node.id].remove(inputValue());\r\n                    }\r\n                });\r\n            }\r\n\r\n            computedSource = computed({\r\n                read: function () {\r\n                    var selectedItems = _.difference(context.unique[node.id](), [inputValue()]).map(function (item) {\r\n                            return {\r\n                                value: item\r\n                            };\r\n                        }),\r\n                        newSource = _.differenceBy(autocompleteSource(), selectedItems, 'value');\r\n                    return newSource;\r\n                },\r\n                write: function (newValues) {\r\n                    autocompleteSource(newValues);\r\n                }\r\n            }).extend({ deferred: true });\r\n        }\r\n\r\n        inputValue.subscribe(function(value) {\r\n            if (value === 'new' && node.children) {\r\n                var multi = createViewModels(node.children);\r\n                // todo - this is very hardcoded, fix\r\n                multi[0].isVisible(true);\r\n                multi[0].mappedChildNodes[0].hasFocus && multi[0].mappedChildNodes[0].hasFocus(true);\r\n                mappedChildNodes(multi);\r\n            }\r\n        });\r\n\r\n        if(node.children) {\r\n            subs.push(computed(function () {\r\n                if(mappedChildNodes().length) {\r\n                    //todo - refactor this so that we arent making so many assumptions..?\r\n                    inputValue(\r\n                        itemMapper(\r\n                            mappedChildNodes()[0].getValue()\r\n                        ).value\r\n                    );\r\n                }\r\n            }));\r\n        }\r\n\r\n        return {\r\n            autocompleteSource: unique ? computedSource : autocompleteSource,\r\n            mappedChildNodes: mappedChildNodes,\r\n            getValue: node.children ? getValue : null,\r\n            setValue: node.children ? setValue : null,\r\n            validations: validations,\r\n            validate: node.children ? validate : undefined,\r\n            setReadonly: setReadonly,\r\n            dispose: function () {\r\n                if(unique) {\r\n                    context.unique[node.id].remove(inputValue());\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n"]}