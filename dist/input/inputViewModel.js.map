{"version":3,"sources":["../../src/input/inputViewModel.js"],"names":[],"mappings":"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","file":"inputViewModel.js","sourcesContent":["import autocompleteViewModel from './autocomplete/autocompleteViewModel';\r\nimport selectViewModel from './select/selectViewModel';\r\nimport dataservice from 'dataservice';\r\nimport sandbox from 'scalejs.sandbox';\r\nimport moment from 'moment';\r\nimport ko from 'knockout';\r\nimport _ from 'lodash';\r\n\r\nimport {\r\n    observable,\r\n    observableArray,\r\n    computed\r\n} from 'scalejs.mvvm';\r\n\r\nvar evaluate = sandbox.expression.evaluate,\r\n    has = sandbox.object.has,\r\n    get = sandbox.object.get,\r\n    is = sandbox.type.is,\r\n    merge = sandbox.object.merge;\r\n\r\n\r\nvar inputTypes = {\r\n    autocomplete: autocompleteViewModel,\r\n    select: selectViewModel\r\n}\r\n\r\nexport default function inputViewModel(node) {\r\n    var // metadata node + context\r\n        options = node.options || {},\r\n        keyMap = node.keyMap || {},\r\n        context = this || {},\r\n\r\n        // inputValue: accepts user input via KO Binding\r\n        inputValue = createInputValue(),\r\n\r\n        // values which can be chosen from\r\n        values = observableArray(Array.isArray(options.values) ? options.values : []),\r\n\r\n        // Depricated?\r\n        isShown = observable(!node.hidden),\r\n\r\n        // 2-way binding with state of focus\r\n        hasFocus = observable(),\r\n\r\n        // 1-way binding with state of hover            \r\n        hover = observable(),\r\n\r\n        // validations\r\n        validations = options.validations || null,\r\n        required = validations ? validations.required : false,\r\n        customError = observable(),\r\n\r\n        // attributes\r\n        disabled = observable(!!options.disabled),\r\n        readonly = observable(!!options.readonly),\r\n        maxlength = validations && validations.maxLength,\r\n\r\n        // patterns\r\n        pattern = options.pattern === true ? getPattern() : options.pattern,\r\n        tooltipShown = observable(false), //for patterns\r\n        shake = observable(false),\r\n\r\n        //specific datepicker\r\n        datePlaceholder = node.inputType === 'datepicker' && ko.pureComputed(function () {\r\n            var placeholder = !hover() || hasFocus() ? '' : 'mm/dd/yyyy';\r\n            return placeholder;\r\n        }),\r\n\r\n        // custom setValue functions for input types                        \r\n        setValueFuncs = {\r\n            checkboxList: setCheckboxListValue\r\n        },\r\n\r\n        // subs disposable array\r\n        subs = [],\r\n\r\n        // how can we define these more clearly / better? Block Scope?\r\n        wasModified, //Needed?\r\n        computedValueExpression, //Needed?\r\n        registeredAction, //Needed?\r\n\r\n        // move out to sandbox?\r\n        formatters = {\r\n            dateFormatter: dateFormatter\r\n        },\r\n        format = options.values && options.values.textFormatter ? formatters[options.values.textFormatter] : _.identity,\r\n\r\n        // BaseViewModel to be passed to Mixins\r\n        viewmodel = {\r\n            mapItem: mapItem,\r\n            inputValue: inputValue,\r\n            hasFocus: hasFocus,\r\n            format: format,\r\n            subs: subs,\r\n            readonly: readonly\r\n        };\r\n\r\n    /*\r\n     * PJSON API (refine)\r\n     */\r\n    function getValue() {\r\n        return inputValue() || '';\r\n    }\r\n\r\n    // function setValue(data) {\r\n    //     if (has(data, 'value')) {\r\n    //         console.error('Use update to set attributes. Use setValue to pass a single value');\r\n    //         value = data.value;\r\n    //     }\r\n    //     // TODO: Refactor - should only accept \"value\", not \"data\".\r\n    //     var wasModifed = inputValue.isModified(),\r\n    //         setFunc = setValueFuncs[node.inputType] || viewmodel.setValue || inputValue;\r\n\r\n    //     inputValue.isModified(wasModifed); //reset isModified\r\n    // }\r\n\r\n    function setValue(data) {\r\n        var value = is(data, 'object') ? data.value : data,\r\n            wasModifed = inputValue.isModified();\r\n        // uses setValueFunc if defined, else updates inputValue\r\n        if (setValueFuncs[node.inputType]) {\r\n            setValueFuncs[node.inputType](data);\r\n        } else if (viewmodel.setValue) {\r\n            viewmodel.setValue(data);\r\n        } else {\r\n            inputValue(value);\r\n        }\r\n\r\n        // programtically setting the inputValue will not cause isModified to become true\r\n        if (!wasModifed) { inputValue.isModified(false); }\r\n    }\r\n\r\n    function update(data) {\r\n        if (data.hasOwnProperty('value')) {\r\n            setValue(data.value);\r\n        }\r\n        if (data.hasOwnProperty('ErrorMessage')) {\r\n            customError(data.ErrorMessage);\r\n        }\r\n    }\r\n\r\n    function validate() {\r\n        console.error('Relying on \"this\" for rendered in validate. REFACTOR');\r\n        inputValue.isModified(true);\r\n        return !inputValue.isValid() && isShown() && this.rendered() && inputValue.severity() === 1;\r\n    }\r\n\r\n    function visibleMessage() {\r\n        // returns the message to be displayed (based on validations)\r\n        var inputMessage, message,\r\n            severity = inputValue.severity();\r\n\r\n        if (!inputValue.isModified() || inputValue.isValid() || !this.rendered() || !isShown()) {\r\n            // the user has yet to modify the input\r\n            // or there is no message. return nothing\r\n            return;\r\n        }\r\n\r\n        inputMessage = inputValue.error();\r\n        inputMessage = inputMessage[inputMessage.length - 1] === '.' ? inputMessage : inputMessage + '.';\r\n\r\n        if (inputMessage === 'Required.') {\r\n            message = (node.errorLabel || node.label) + ' is required.';\r\n        } else {\r\n            message = (node.errorLabel || node.label) + ' is invalid. ' + inputMessage;\r\n        }\r\n\r\n        return {\r\n            message,\r\n            severity,\r\n            onClick() {\r\n                hasFocus(true);\r\n            }\r\n        };\r\n    }\r\n\r\n    /*\r\n     * Rule Engine (todo - Refactor out)\r\n     */\r\n\r\n    function assignDate(value, params) {\r\n        if (!is(params, 'object')) {\r\n            console.error('Assign date only supports object params', params);\r\n            return;\r\n        }\r\n        var newDate = moment(value).add(params).format(options.rawFormat || 'YYYY-MM-DD');\r\n        setValue(newDate);\r\n    }\r\n\r\n    function setDisabled(value) {\r\n        if (value === 'toggle') {\r\n            disabled(!disabled());\r\n            return;\r\n        }\r\n        disabled(value);\r\n    }\r\n\r\n    function setReadonly(bool) {\r\n        readonly(bool)\r\n    }\r\n\r\n    function setCheckboxListValue(data) {\r\n        if (Array.isArray(data.value)) {\r\n            inputValue(data.value);\r\n        } else if (data.value !== null && data.value !== undefined) {\r\n            inputValue([data.value]);\r\n        } else {\r\n            inputValue([]);\r\n        }\r\n    }\r\n\r\n    /*\r\n     * Internal\r\n     */\r\n    function createInputValue() {\r\n        // checkboxList can have multiple answers so make it an array\r\n        if (node.inputType === 'checkboxList') {\r\n            return observableArray(options.value || []);\r\n        } else {\r\n            // if there is no initial value, set it to empty string,\r\n            // so that isModified does not get triggered for empty dropdowns\r\n            return observable(has(options.value) ? options.value : '');\r\n        }\r\n    }\r\n\r\n\r\n    function getPattern() {\r\n        // implicitly determine pattern (inputmask) if there is a Regex validation\r\n        if (validations && validations.pattern) {\r\n            return {\r\n                alias: 'Regex',\r\n                regex: validations.pattern.params\r\n            };\r\n        }\r\n    }\r\n\r\n    /*\r\n     * Utils (can be Refactored to common)\r\n     */\r\n\r\n    function dateFormatter(date) {\r\n        return moment(date).format('MM/DD/YYYY');\r\n    }\r\n\r\n    function mapItem(mapper) {\r\n        var textKey = Array.isArray(mapper.textKey) ? mapper.textKey : [mapper.textKey],\r\n            valueKey = Array.isArray(mapper.valueKey) ? mapper.valueKey : [mapper.valueKey],\r\n            textFormatter = formatters[mapper.textFormatter] || _.identity,\r\n            delimeter = mapper.delimeter || ' / ';\r\n\r\n        return function (val) {\r\n            return {\r\n                text: textFormatter(\r\n                    textKey.map((k) => { val[k]; }).join(delimiter)\r\n                ),\r\n                value: valueKey.map((k) => { return val[k]; }).join(delimeter),\r\n                original: val\r\n            }\r\n        }\r\n    }\r\n\r\n\r\n    /*\r\n     * Init\r\n     */\r\n\r\n    // Mixin the viewModel specific to the inputType\r\n    if (inputTypes[node.inputType]) {\r\n        extend(viewmodel, inputTypes[node.inputType].call(context, node, viewmodel));\r\n    }\r\n\r\n    // Checkbox underlying value is Array because of knockout, maybe refactor to a custom binding?\r\n    if (node.inputType === 'checkbox') {\r\n        values.subscribe((newValues) => {\r\n            if (newValues.indexOf(options.checked) !== -1) {\r\n                inputValue(options.checked);\r\n            } else {\r\n                inputValue(options.unchecked);\r\n            }\r\n        });\r\n        if (inputValue() === options.checked) {\r\n            values.push(options.checked);\r\n        }\r\n    }\r\n\r\n    // TODO: Specific to data, move into custom viewModel?\r\n    // make min/max date into observables\r\n    if (options.minDate) {\r\n        viewmodel.minDate = ko.observable(options.minDate);\r\n    }\r\n    if (options.maxDate) {\r\n        viewmodel.maxDate = ko.observable(options.maxDate);\r\n    }\r\n\r\n    // Is this needed in the common? Should it be a plugin/mixin?\r\n    if (options.registered) {\r\n        registeredAction = sandbox.metadataFactory.createViewModel.call(this, {\r\n            type: 'action',\r\n            actionType: 'ajax',\r\n            options: merge(options.registered, { data: {} })\r\n        });\r\n\r\n        inputValue.subscribe(function (newValue) {\r\n            registeredAction.options.data[node.id] = newValue; //our own sub gets called before context is updated\r\n            if (newValue !== '') {\r\n                registeredAction.action({\r\n                    callback: (error, data) => {\r\n                        Object.keys(data).forEach((key) => {\r\n                            if (!context.dictionary && !context.data) {\r\n                                console.warn('Using a registered input when no data/dictionary available in context', node);\r\n                                return;\r\n                            }\r\n                            var node = context.dictionary && context.dictionary()[key];\r\n                            if (node && node.update) {\r\n                                node.update(data[key]);\r\n                            } else if (context.data && has(data[key], 'value')) {\r\n                                context.data()[key] = data[key].value;\r\n                            }\r\n                        });\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    }\r\n\r\n    // TODO: Clean up validation Code \r\n    // add validations to the inputvalue\r\n    validations = merge(_.cloneDeep(options.validations), { customError: customError });\r\n    if (validations.expression) {\r\n        validations.expression.params = [\r\n            options.validations.expression.message ?\r\n                options.validations.expression.term\r\n                : options.validations.expression,\r\n            context.getValue\r\n        ]\r\n    }\r\n    if (viewmodel.validations) {\r\n        validations = merge(validations, viewmodel.validations);\r\n    }\r\n    inputValue = inputValue.extend(validations);\r\n\r\n    // allows us to set values on an input from expression\r\n    // usecase: issuerId coming from noticeboard\r\n    if (options.valueExpression) {\r\n        computedValueExpression = computed(() => {\r\n            if (options.allowSet === false) {\r\n                inputValue(); // re-eval when inputValue is set\r\n            }\r\n            return evaluate(options.valueExpression, context.getValue);\r\n        });\r\n        setValue(computedValueExpression());\r\n        computedValueExpression.subscribe(setValue(value));\r\n        subs.push(computedValueExpression)\r\n    }\r\n\r\n    // Insert Zeros Option?\r\n    if (get(options, 'pattern.alias') === 'percent') {\r\n        inputValue.subscribe((value) => {\r\n            if (value && isFinite(Number(value))) {\r\n                inputValue(Number(value).toFixed(3));\r\n            }\r\n        });\r\n    }\r\n\r\n    shake.subscribe((shook) => {\r\n        shook && setTimeout(() => {\r\n            shake(false);\r\n        }, 1000);\r\n    });\r\n\r\n\r\n    return merge(node, viewmodel, {\r\n        inputValue,\r\n        visibleMessage,\r\n        customError,\r\n        hasFocus,\r\n        hover,\r\n        datePlaceholder,\r\n        assignDate,\r\n        setDisabled,\r\n        isShown,\r\n        required,\r\n        readonly,\r\n        disabled,\r\n        maxlength,\r\n        pattern,\r\n        tooltipShown,\r\n        shake,\r\n        options,\r\n        setValue,\r\n        update,\r\n        context: this,\r\n        error: inputValue.error,\r\n\r\n        // Mixin-Overrides        \r\n        getValue: viewmodel.getValue || getValue,\r\n        values: viewmodel.values || values,\r\n        setReadonly: viewmodel.setReadonly || setReadonly,\r\n        validate: viewmodel.validate || validate,\r\n\r\n        dispose: function () {\r\n            if (viewmodel.dispose) {\r\n                viewmodel.dispose();\r\n            }\r\n            //sandbox.utils.disposalAll(subs)(); TODO\r\n            (subs || []).forEach(function (sub) {\r\n                sub.dispose && sub.dispose();\r\n            });\r\n        }\r\n    });\r\n};\r\n\r\n\r\n\r\n    // implements an input of type\r\n    // text, select, date, radio, checkbox, checkboxList   \r\n\r\n    //TODO: Refactor Session\r\n    //- createJSDocs\r\n    //- revisit and de-tangle bindings\r\n    //- refactor validations so that the tooltip works without inputText wrapper in the inputType template\r\n    //- remove knockout require\r\n    //- move dataservice to sandbox\r\n    //- move tooltip/helpText in options\r\n    //- move tooltip into pattern object (if pattern is true, use message from validation obj)\r\n    //\r\n    // ...add more refactor session goals here!\r\n\r\n    /**\r\n     *  input is the component to use when accepting user-input.\r\n     *  This is the best way to create an interactive UI and\r\n     *  autogenerate your underlying data model by using an adapter in the parent chain.\r\n     *\r\n     * @module input\r\n     *\r\n     * @param {object} node\r\n     *  The configuration specs for the component.\r\n     * @param {string} [node.id]\r\n     *  By specifying an \"id\" on your input, you are automatically adding your input's data to the data context model.\r\n     * @param {object} node.options\r\n     *  The options pertaining to your specific inputType\r\n     * @param {array} [node.options.values]\r\n     *  The values that can be chosen from for inputTypes that have selections (e.g. radio, checkboxList)\r\n     * @param {boolean} [node.hidden=false]\r\n     *  Whether or not to hide the input\r\n     * @param {object} [node.options.validations]\r\n     *  KO validations object to validate the inputValue\r\n     * @param {boolean} [node.options.validations.required]\r\n     *  Required validation for ko - also will show * next to label indicating it is required\r\n     * @param {boolean} [node.options.disabled]\r\n     *  Disables the input\r\n     * @param {object|string|boolean} [node.options.pattern]\r\n     *  Sets an inputmask for the input. If a string, this is the mask. If an object, gets passed as is.\r\n     *  If boolean = true, uses pattern validation.\r\n     */"]}