{"version":3,"sources":["../../../src/action/actions/ajax.js"],"names":[],"mappings":"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","file":"ajax.js","sourcesContent":["import sandbox from 'scalejs.sandbox';\nimport { createViewModel } from 'scalejs.mvvm';\nimport mustache from 'mustache';\nimport _ from 'lodash';\nimport dataservice from 'dataservice';\n\nimport { registerActions } from '../actionModule';\n\nconst has = sandbox.object.has,\n      merge = _.merge,\n      is = sandbox.type.is;\n\nfunction ajax(options, args) {\n    let data = this.data && this.data(),\n        target = options.target,\n        optionData = options.data || {},\n        uri = mustache.render(options.target.uri, merge(data, optionData)),\n        contextValue,\n        context = this,\n        callback = args && args.callback,\n        nextAction;\n\n    target.data = target.data || {};\n    // if(target.data === undefined) {\n    //     target.data = {};\n    // }\n\n    if (options.sendAllData) {\n        target.data = this.data();\n    } else if (options.keyMap) {\n        target.data[options.keyMap.dataId] = this.data()[options.keyMap.dataId];\n    }\n\n    if(options.contextId) {\n        contextValue = has(this[options.contextId]) ? this[options.contextId] : this.getValue && this.getValue(options.contextId);\n        target.data[options.contextId] = contextValue;\n    }\n\n    if(options.submittedData) { //todo: what is this?\n        target.data = options.params;\n    } else if (options.params) {\n        target.data = renderParams(options.params, merge(data, paramData));\n    }\n\n    if (Array.isArray(options.sendDataKeys)) {\n        target.data = options.sendDataKeys.reduce(function(o, k) {\n            let receiverKey = k, supplierKey = k;\n            if(is(k, 'object')) {\n                Object.keys(k).forEach(function (key) {\n                    receiverKey = key;\n                    supplierKey = k[key];\n                });\n            }\n            if(!has(data[supplierKey])) {\n                console.warn('Data key missing from data', supplierKey);\n                o[receiverKey] = null;\n                return o;\n            }\n            let value = data[supplierKey];\n            if(typeof value === 'string') { value = value.trim(); }\n            o[receiverKey] = value;\n            return o;\n        }, {});\n    }\n\n    nextAction =  function (error, results) {\n        let opts = options ? _.cloneDeep(options) : {},\n            err = error || (results && (results.Status === 'FAILURE' || results.Status === 'FAILED') ? results : null); // handle 200ok but still an error\n\n        ((err ? opts.errorActions : opts.nextActions) || []).forEach(function (item) {\n            // ROB & DRAISY - overwrite the errorAction's message with message from server\n            // todo: revisit and refactor.\n            if (err && opts.errorActions){\n                opts.errorActions.forEach(function(errorAction){\n                    // handle OperationException\n                    if (errorAction.options.message && get(error, 'OperationException.ErrorMessage')) {\n                        errorAction.options.message = get(error, 'OperationException.ErrorMessage');\n                    }\n                    if (errorAction.options.message && error.message) {\n                        errorAction.options.message = error.message;\n                    }\n                });\n            }\n\n            // get the results of the request and push\n            let response = {\n                request: options.target,\n                error: error,\n                results: results\n            };\n\n            item.options = merge(response, item.options);\n            let createViewModel = sandbox.metadataFactory.createViewModel.bind(context);\n            createViewModel(item).action();\n        });\n\n        if (callback) {\n            callback.apply(null, arguments);\n        }\n    };\n\n    dataservice.ajax(merge(target, { uri: uri }), nextAction);\n}\n\nregisterActions({ajax});"]}